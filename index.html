<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phasenetwork Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fira Code', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
            --glow-color: #00aaff;
        }
        .container-glow {
            box-shadow: 0 0 5px var(--glow-color), 0 0 10px var(--glow-color), 0 0 15px var(--glow-color);
            border: 1px solid var(--glow-color);
        }
        .btn-glow {
            background-color: transparent;
            border: 1px solid var(--glow-color);
            color: var(--glow-color);
            text-shadow: 0 0 5px var(--glow-color);
            transition: all 0.3s ease;
        }
        .btn-glow:hover {
            background-color: var(--glow-color);
            color: #0d1117;
            box-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color);
        }
        .input-glow {
            background-color: #161b22;
            border: 1px solid #30363d;
            color: #c9d1d9;
            transition: all 0.3s ease;
        }
        .input-glow:focus {
            outline: none;
            border-color: var(--glow-color);
            box-shadow: 0 0 5px var(--glow-color);
        }
        .text-glow {
            text-shadow: 0 0 8px var(--glow-color);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: var(--glow-color); border-radius: 4px; }
        .blinking-cursor {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { border-color: transparent }
            50% { border-color: var(--glow-color); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- Config Error View -->
        <div id="config-error-view" class="hidden container-glow p-8 rounded-lg text-center">
            <h1 class="text-3xl font-bold text-red-500 mb-4 text-glow">Configuration Needed</h1>
            <p class="text-lg">Please open the <code>index.html</code> file and replace <code>'YOUR_SUPABASE_URL'</code> and <code>'YOUR_SUPABASE_ANON_KEY'</code> with your actual Supabase credentials.</p>
            <p class="mt-4 text-gray-400">You can find these in your Supabase project under Project Settings > API.</p>
        </div>

        <!-- Login / Signup View -->
        <div id="auth-view" class="hidden container-glow p-8 rounded-lg">
            <h1 class="text-4xl font-bold text-glow mb-4 text-center">Phasenetwork Terminal</h1>
            <p class="text-center text-gray-400 mb-8">Authentication Required<span class="blinking-cursor border-r-2 ml-1"></span></p>
            
            <div id="auth-forms-container">
                <!-- Login Form -->
                <form id="login-form" class="space-y-4">
                    <h2 class="text-2xl text-glow">Login</h2>
                    <input type="email" id="login-email" placeholder="email@domain.com" class="w-full p-3 rounded-md input-glow" required>
                    <input type="password" id="login-password" placeholder="password" class="w-full p-3 rounded-md input-glow" required>
                    <button type="submit" class="w-full p-3 rounded-md btn-glow font-bold">Access System</button>
                    <p class="text-center text-gray-400">First time? <a href="#" id="show-signup" class="text-glow hover:underline">Create an account.</a></p>
                </form>

                <!-- Signup Form -->
                <form id="signup-form" class="space-y-4 hidden">
                    <h2 class="text-2xl text-glow">Create Account</h2>
                    <input type="text" id="signup-username" placeholder="username" class="w-full p-3 rounded-md input-glow" required>
                    <input type="email" id="signup-email" placeholder="email@domain.com" class="w-full p-3 rounded-md input-glow" required>
                    <input type="password" id="signup-password" placeholder="password" class="w-full p-3 rounded-md input-glow" required>
                    <button type="submit" class="w-full p-3 rounded-md btn-glow font-bold">Register Account</button>
                    <p class="text-center text-gray-400">Already have an account? <a href="#" id="show-login" class="text-glow hover:underline">Login.</a></p>
                </form>
            </div>
            <p id="auth-error" class="text-red-500 mt-4 text-center"></p>
        </div>

        <!-- Main App View (Quiz Selection, Leaderboard) -->
        <div id="main-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-glow">Welcome, <span id="username-display"></span></h1>
                <button id="logout-btn" class="btn-glow px-4 py-2 rounded-md">Logout</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Quiz Selection -->
                <div class="md:col-span-2 container-glow p-6 rounded-lg">
                    <h2 class="text-2xl text-glow mb-4">Select a Vulnerability Module</h2>
                    <div id="quiz-list" class="space-y-3">
                        <!-- Quizzes will be populated here -->
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="md:col-span-1 container-glow p-6 rounded-lg">
                    <h2 class="text-2xl text-glow mb-4">Live Leaderboard</h2>
                    <ul id="leaderboard-list" class="space-y-2">
                        <!-- Leaderboard will be populated here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Quiz View -->
        <div id="quiz-view" class="hidden container-glow p-8 rounded-lg">
            <h2 id="quiz-title" class="text-3xl text-glow font-bold mb-6 text-center"></h2>
            <div id="question-container">
                <p id="question-text" class="text-xl mb-4"></p>
                <div id="options-container" class="space-y-3"></div>
            </div>
            <div id="quiz-result" class="hidden text-center">
                <h3 class="text-4xl font-bold text-glow mb-4">Quiz Complete!</h3>
                <p class="text-2xl mb-6">Your score: <span id="final-score"></span></p>
                <div class="flex gap-4 justify-center">
                   <button id="post-score-btn" class="btn-glow px-6 py-3 rounded-md">Post to Leaderboard</button>
                   <button id="back-to-main-btn" class="btn-glow px-6 py-3 rounded-md">Back to Main</button>
                </div>
            </div>
            <p id="feedback" class="mt-4 text-center font-bold"></p>
        </div>

    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- Supabase Config (REPLACE with your actual credentials) ---
        const supabaseUrl = 'https://pfmlwfogpkdidzbkdkjc.supabase.co'; // Found in Project Settings > API
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmbWx3Zm9ncGtkaWR6Ymtka2pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNDQ1MjUsImV4cCI6MjA3MzYyMDUyNX0.FpmBlnf-jkD64MFNGBjZxrrdNTID2am0EL3HwcUmhjc'; // Found in Project Settings > API

        // --- DOM Elements ---
        const configErrorView = document.getElementById('config-error-view');
        const authView = document.getElementById('auth-view');
        const mainView = document.getElementById('main-view');
        const quizView = document.getElementById('quiz-view');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const usernameDisplay = document.getElementById('username-display');
        const logoutBtn = document.getElementById('logout-btn');
        const quizList = document.getElementById('quiz-list');
        const leaderboardList = document.getElementById('leaderboard-list');
        const quizTitle = document.getElementById('quiz-title');
        const questionContainer = document.getElementById('question-container');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const quizResult = document.getElementById('quiz-result');
        const finalScore = document.getElementById('final-score');
        const postScoreBtn = document.getElementById('post-score-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const feedback = document.getElementById('feedback');
        
        // --- App State ---
        let currentUser = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let score = 0;

        // --- App Initialization Logic ---
        // FIX: Check for placeholder credentials before initializing Supabase.
        // This prevents the "Invalid supabaseUrl" error and guides the user.
        if (supabaseUrl.includes('YOUR_SUPABASE_URL') || supabaseKey.includes('YOUR_SUPABASE_ANON_KEY')) {
            configErrorView.classList.remove('hidden');
        } else {
            initializeApp();
        }

        function initializeApp() {
            const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

            // --- Quiz Data ---
            const quizzes = {
                "price-tampering": {
                    title: "Price Tampering",
                    questions: [
                        { question: "What is Price Tampering?", options: ["Changing item price in your favor", "A website pricing error", "Negotiating a price", "Stealing credit cards"], answer: 0 },
                        { question: "Where does price tampering occur?", options: ["Client-side", "Server Database", "In-store systems", "Customer support call"], answer: 0 },
                        { question: "How is price tampering best prevented?", options: ["Client-side encryption", "Server-side validation", "Hidden HTML fields", "JavaScript validation"], answer: 1 },
                        { question: "Changing an item's value from $100 to $1 in dev tools is called:", options: ["XSS", "SQL Injection", "Client-Side Parameter Tampering", "DoS"], answer: 2 },
                    ]
                },
                "sql-injection": {
                    title: "SQL Injection",
                    questions: [
                        { question: "What does SQL Injection target?", options: ["Frontend JavaScript", "CSS Styles", "Backend Database", "User's browser"], answer: 2 },
                        { question: "What is the purpose of ' or 1=1; --'?", options: ["To fix a bug", "To bypass login", "To delete a table", "To select a username"], answer: 1 },
                        { question: "Which technique prevents SQLi?", options: ["Input validation", "Hiding database errors", "Parameterized queries", "Using firewalls"], answer: 2 },
                    ]
                },
                "xss": {
                    title: "Cross-Site Scripting (XSS)",
                    questions: [
                        { question: "What is the goal of a stored XSS attack?", options: ["Steal cookies", "Deface a website", "Inject a script for all users", "Crash the server"], answer: 2 },
                        { question: "Which tag is commonly used for XSS?", options: ["<div>", "<img>", "<p>", "<script>"], answer: 3 },
                        { question: "How to prevent XSS?", options: ["Encrypting cookies", "Output encoding", "Using HTTPS", "Blocking IP addresses"], answer: 1 },
                    ]
                }
            };

            // --- Functions ---

            const showView = (viewId) => {
                authView.classList.add('hidden');
                mainView.classList.add('hidden');
                quizView.classList.add('hidden');
                configErrorView.classList.add('hidden');
                document.getElementById(viewId).classList.remove('hidden');
            };

            const displayAuthError = (message) => {
                authError.textContent = message;
            };

            const fetchLeaderboard = async () => {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .order('score', { ascending: false })
                    .limit(10);
                
                if (error) {
                    console.error("Error fetching leaderboard:", error);
                    return;
                }

                leaderboardList.innerHTML = '';
                data.forEach((entry, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-800/50 p-2 rounded';
                    li.innerHTML = `
                        <span>${index + 1}. ${entry.username}</span>
                        <span class="font-bold text-glow">${entry.score}</span>
                    `;
                    leaderboardList.appendChild(li);
                });
            };

            const setupRealtimeLeaderboard = () => {
                supabaseClient.channel('public:leaderboard')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'leaderboard' }, payload => {
                        fetchLeaderboard();
                    })
                    .subscribe();
            };

            const populateQuizzes = () => {
                quizList.innerHTML = '';
                for (const key in quizzes) {
                    const quiz = quizzes[key];
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-3 rounded-md btn-glow';
                    button.textContent = `> ${quiz.title}`;
                    button.onclick = () => startQuiz(key);
                    quizList.appendChild(button);
                }
            };

            const startQuiz = (quizKey) => {
                currentQuiz = quizzes[quizKey];
                currentQuestionIndex = 0;
                score = 0;
                quizTitle.textContent = currentQuiz.title;
                questionContainer.classList.remove('hidden');
                quizResult.classList.add('hidden');
                feedback.textContent = '';
                postScoreBtn.disabled = false;
                displayQuestion();
                showView('quiz-view');
            };
            
            const displayQuestion = () => {
                const question = currentQuiz.questions[currentQuestionIndex];
                questionText.textContent = question.question;
                optionsContainer.innerHTML = '';
                question.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'block w-full text-left p-3 rounded-md btn-glow';
                    button.textContent = option;
                    button.onclick = () => selectAnswer(index);
                    optionsContainer.appendChild(button);
                });
            };
            
            const selectAnswer = (selectedIndex) => {
                const question = currentQuiz.questions[currentQuestionIndex];
                if (selectedIndex === question.answer) {
                    score++;
                    feedback.textContent = "Correct!";
                    feedback.className = "mt-4 text-center font-bold text-green-500";
                } else {
                    feedback.textContent = "Incorrect.";
                    feedback.className = "mt-4 text-center font-bold text-red-500";
                }
                
                currentQuestionIndex++;
                setTimeout(() => {
                    feedback.textContent = '';
                    if (currentQuestionIndex < currentQuiz.questions.length) {
                        displayQuestion();
                    } else {
                        showQuizResult();
                    }
                }, 1000);
            };

            const showQuizResult = () => {
                questionContainer.classList.add('hidden');
                quizResult.classList.remove('hidden');
                finalScore.textContent = `${score} / ${currentQuiz.questions.length}`;
            };

            const postScore = async () => {
                if (!currentUser) return;
                postScoreBtn.disabled = true;

                const { error } = await supabaseClient.from('leaderboard').insert([
                    { 
                        user_id: currentUser.id,
                        username: currentUser.user_metadata.username, 
                        score: score 
                    }
                ]);

                if (error) {
                    console.error("Error posting score:", error);
                    alert("Error posting score.");
                    postScoreBtn.disabled = false;
                } else {
                    alert("Score posted successfully!");
                }
            };

            // --- Event Listeners ---

            showSignup.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                displayAuthError('');
            });
            
            showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                displayAuthError('');
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) displayAuthError(error.message);
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('signup-username').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const { error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { username: username }
                    }
                });
                if (error) displayAuthError(error.message);
            });
            
            logoutBtn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
            });

            postScoreBtn.addEventListener('click', postScore);
            backToMainBtn.addEventListener('click', () => showView('main-view'));

            // --- Auth State Change Listener ---

            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (session) {
                    currentUser = session.user;
                    usernameDisplay.textContent = currentUser.user_metadata.username;
                    populateQuizzes();
                    fetchLeaderboard();
                    setupRealtimeLeaderboard();
                    showView('main-view');
                } else {
                    currentUser = null;
                    showView('auth-view');
                }
            });
        }
    </script>
</body>
</html>

